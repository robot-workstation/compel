<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compel Robot</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#fff;color:#111}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .top{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button{padding:10px 12px;border-radius:10px;border:1px solid #d6dbe6;background:#fff;color:#111}
    input{min-width:320px;flex:1}
    button{cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#6b7280;font-size:13px;margin-top:8px}
    .card{border:1px solid #e5e7eb;background:#fff;border-radius:14px;padding:12px;margin-top:14px}
    .cardHead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .title{font-weight:700}
    .brandGrid{
      margin-top:10px;
      column-count: 3;
      column-gap: 18px;
    }
    @media (max-width: 980px){ .brandGrid{column-count:2} }
    @media (max-width: 640px){ .brandGrid{column-count:1} }

    .brandItem{
      break-inside: avoid;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:8px 0;
      border-bottom:1px solid #f0f2f6;
    }
    .brandLeft{display:flex;align-items:center;gap:10px;min-width:0}
    .brandName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width: 320px}
    .count{color:#374151;font-size:13px;white-space:nowrap}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef2f7;vertical-align:top;text-align:left}
    th{background:#fafafa;position:sticky;top:0}
    a{color:#2563eb;text-decoration:none}
    .tableWrap{margin-top:10px;overflow:auto;max-height:70vh;border-radius:12px;border:1px solid #eef2f7}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <input id="catUrl" placeholder="Kategori URL (örn: https://compel.com.tr/10-dj-urunleri)" />
      <input id="maxPages" type="number" min="0" value="0" title="0 = tüm sayfalar" style="max-width:170px" />
      <button id="btnRun">Getir</button>
      <button id="btnStop" disabled>Dur</button>
    </div>
    <div class="muted">Max sayfa = 0 ise kategorideki tüm sayfaları çeker.</div>

    <section class="card">
      <div class="cardHead">
        <div>
          <div class="title">Markalar (A → Z)</div>
          <div class="muted" id="brandMeta">0 marka</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <button id="btnSelectAll" disabled>Tümünü Seç</button>
          <span class="muted" id="status">Hazır.</span>
        </div>
      </div>

      <div class="brandGrid" id="brandList"></div>
    </section>

    <section class="card">
      <div class="cardHead">
        <div>
          <div class="title">Ürünler</div>
          <div class="muted" id="prodMeta">0 ürün</div>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:160px">Marka</th>
              <th style="min-width:360px">Ürün</th>
              <th style="min-width:120px">Kod</th>
              <th style="min-width:140px">Stok</th>
              <th style="min-width:80px">Link</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
(() => {
  const WORKER = "https://robot-workstation.tvkapora.workers.dev";

  const $ = (id) => document.getElementById(id);

  const elCat = $("catUrl");
  const elMax = $("maxPages");
  const btnRun = $("btnRun");
  const btnStop = $("btnStop");
  const btnSelectAll = $("btnSelectAll");
  const brandList = $("brandList");
  const brandMeta = $("brandMeta");
  const prodMeta = $("prodMeta");
  const statusEl = $("status");
  const rowsEl = $("rows");

  const state = {
    ctrl: null,
    products: [],
    brandCounts: new Map(),
    filterMode: "ALL",        // "ALL" | "CUSTOM"
    selectedBrands: new Set(),// CUSTOM modunda kullanılır
    rowByUrl: new Map(),
    allBrands: [],
  };

  const enc = encodeURIComponent;

  const setStatus = (s) => statusEl.textContent = s;

  function escapeHtml(s) {
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function shouldShowBrand(brand) {
    if (state.filterMode === "ALL") return true;
    return state.selectedBrands.has(brand);
  }

  function applyFilter() {
    for (const p of state.products) {
      const tr = state.rowByUrl.get(p.url);
      if (!tr) continue;
      tr.style.display = shouldShowBrand(p.brand) ? "" : "none";
    }
  }

  function renderBrands() {
    const items = [...state.brandCounts.entries()]
      .map(([brand, count]) => ({ brand, count }))
      .sort((a,b) => a.brand.localeCompare(b.brand, "tr"));

    state.allBrands = items.map(x => x.brand);
    brandMeta.textContent = `${items.length} marka`;

    brandList.innerHTML = items.map(({brand,count}) => {
      const checked = (state.filterMode === "ALL") ? true : state.selectedBrands.has(brand);
      return `
        <div class="brandItem">
          <label class="brandLeft" title="${escapeHtml(brand)}">
            <input type="checkbox" data-brand="${escapeHtml(brand)}" ${checked ? "checked" : ""} />
            <span class="brandName">${escapeHtml(brand)}</span>
          </label>
          <span class="count">${count} ürün</span>
        </div>
      `;
    }).join("");

    brandList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.addEventListener("change", () => {
        const brand = cb.getAttribute("data-brand");

        // ALL modundayken ilk değişiklikte CUSTOM'a geç
        if (state.filterMode === "ALL") {
          state.filterMode = "CUSTOM";
          state.selectedBrands = new Set(state.allBrands); // hepsi seçili başlasın
        }

        if (cb.checked) state.selectedBrands.add(brand);
        else state.selectedBrands.delete(brand);

        // tekrar hepsi seçili olduysa ALL'a geri dön
        if (state.selectedBrands.size === state.allBrands.length) {
          state.filterMode = "ALL";
          state.selectedBrands.clear();
        }

        applyFilter();
        // checkboxlar ALL moduna döndüyse hepsi işaretli görünsün
        if (state.filterMode === "ALL") renderBrands();
      });
    });

    btnSelectAll.disabled = items.length === 0;
  }

  function addRow(p) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.brand)}</td>
      <td>${escapeHtml(p.name)}</td>
      <td>${escapeHtml(p.code)}</td>
      <td>${escapeHtml(p.stock)}</td>
      <td><a href="${p.url}" target="_blank" rel="noopener">Aç</a></td>
    `;
    rowsEl.appendChild(tr);
    state.rowByUrl.set(p.url, tr);
    tr.style.display = shouldShowBrand(p.brand) ? "" : "none";
  }

  async function fetchJSON(url, signal) {
    const r = await fetch(url, { signal });
    if (!r.ok) throw new Error("fetch_failed");
    return await r.json();
  }

  async function fetchLinks(categoryUrl, maxPages, signal) {
    const first = await fetchJSON(`${WORKER}/list?b=${enc(categoryUrl)}&p=1`, signal);
    const totalPages = first.pages || 1;
    const wantPages = (maxPages && maxPages > 0) ? Math.min(maxPages, totalPages) : totalPages;

    const all = new Set(first.links || []);
    for (let page = 2; page <= wantPages; page++) {
      const j = await fetchJSON(`${WORKER}/list?b=${enc(categoryUrl)}&p=${page}`, signal);
      (j.links || []).forEach(x => all.add(x));
      setStatus(`Liste: Sayfa ${page}/${wantPages} (link: ${all.size})`);
    }
    return [...all];
  }

  async function runQueue(items, workerFn, concurrency, signal) {
    let i = 0, done = 0;
    const results = [];
    const runners = new Array(concurrency).fill(0).map(async () => {
      while (i < items.length) {
        const idx = i++;
        if (signal.aborted) break;
        try {
          results[idx] = await workerFn(items[idx], idx);
        } catch {
          results[idx] = null;
        } finally {
          done++;
          setStatus(`Ürünler: ${done}/${items.length}`);
        }
      }
    });
    await Promise.all(runners);
    return results;
  }

  async function start() {
    const categoryUrl = (elCat.value || "").trim();
    if (!categoryUrl.startsWith("https://compel.com.tr/")) {
      alert("Kategori URL https://compel.com.tr/ ile başlamalı");
      return;
    }

    btnRun.disabled = true;
    btnStop.disabled = false;
    btnSelectAll.disabled = true;

    state.ctrl = new AbortController();
    const signal = state.ctrl.signal;

    // reset (her çalıştırmada temiz başla)
    rowsEl.innerHTML = "";
    brandList.innerHTML = "";
    state.products = [];
    state.brandCounts = new Map();
    state.filterMode = "ALL";
    state.selectedBrands.clear();
    state.rowByUrl.clear();
    state.allBrands = [];
    prodMeta.textContent = "0 ürün";
    brandMeta.textContent = "0 marka";

    try {
      const maxPages = parseInt(elMax.value || "0", 10) || 0;

      setStatus("Linkler alınıyor…");
      const links = await fetchLinks(categoryUrl, maxPages, signal);
      setStatus(`Toplam ${links.length} link bulundu. Ürünler çekiliyor…`);

      const prodFn = async (url) => {
        const j = await fetchJSON(`${WORKER}/prod?u=${enc(url)}`, signal);
        return {
          url: j.url || url,
          name: j.name || "",
          code: j.code || "",
          brand: (j.brand || "").trim() || "Bilinmiyor",
          stock: j.stock || "",
        };
      };

      const out = await runQueue(links, prodFn, 8, signal);

      for (const p of out.filter(Boolean)) {
        state.products.push(p);
        state.brandCounts.set(p.brand, (state.brandCounts.get(p.brand) || 0) + 1);
        addRow(p);
      }

      prodMeta.textContent = `${state.products.length} ürün`;
      renderBrands();
      applyFilter();
      setStatus("Bitti ✅");
    } catch (e) {
      if (e?.name === "AbortError") setStatus("Durduruldu.");
      else setStatus("Hata oldu (fetch_failed).");
    } finally {
      btnStop.disabled = true;
      btnRun.disabled = false;
      state.ctrl = null;
    }
  }

  btnRun.addEventListener("click", start);

  btnStop.addEventListener("click", () => {
    if (state.ctrl) state.ctrl.abort();
  });

  btnSelectAll.addEventListener("click", () => {
    state.filterMode = "ALL";
    state.selectedBrands.clear();
    renderBrands();
    applyFilter();
  });

  // varsayılan
  elCat.value = "https://compel.com.tr/10-dj-urunleri";
  setStatus("Hazır.");
})();
</script>
</body>
</html>
