<!doctype html><html lang="tr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Compel Marka Tarayıcı</title><style>
:root{color-scheme:dark}html,body{height:100%}body{margin:0;height:100vh;overflow:hidden;display:flex;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0d12;color:#eaeef7}
main{flex:1;overflow:hidden;display:grid;grid-template-columns:480px 1fr;min-height:0}
aside{border-right:1px solid #1f2430;padding:8px;overflow:hidden;display:flex;flex-direction:column;min-height:0}
section{padding:8px;overflow:hidden;display:flex;flex-direction:column;min-height:0}

.btnrow{display:flex;gap:8px;margin:0 0 8px;flex-wrap:wrap;justify-content:center;flex:0 0 auto}
button,.ibox{background:#111827;color:#eaeef7;border:1px solid #2a3140;border-radius:10px;font-weight:600;font-size:13px}
button{padding:8px 10px;cursor:pointer}
button:hover{background:#1f2a44;border-color:#6b7da6}
button:disabled{opacity:.6;cursor:not-allowed}
button:disabled:hover{background:#111827;border-color:#2a3140}

/* ✅ bilgi kutusu: 1 satır kısaltıldı */
.ibox{padding:8px 10px;margin:0 0 10px;height:34px;overflow:auto;display:flex;flex-wrap:wrap;gap:6px;align-content:flex-start}
.chip{padding:2px 6px;border:1px solid #2a3140;border-radius:999px;background:#0f1320;white-space:nowrap;font-weight:600;font-size:14px}

.list{flex:1;min-height:0;overflow:auto;display:grid;grid-template-columns:repeat(2,1fr);gap:6px 10px;align-content:start}
.brand{display:flex;align-items:center;padding:5px 10px;border:1px solid #1f2430;border-radius:12px;background:#0f1320;cursor:pointer;user-select:none;width:100%;box-sizing:border-box}
.brand:hover{border-color:#2a3140}.brand.sel{background:#1f2a44;border-color:#6b7da6}
.row{display:grid;grid-template-columns:32px 1fr auto;gap:2px;align-items:center;min-width:0}
.idx{font-variant-numeric:tabular-nums;opacity:.9;white-space:nowrap;margin-right:6px}
.nm{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:800;font-size:16px;line-height:1.2}
.ct{white-space:nowrap;opacity:.9;font-size:11px;margin-left:2px}

.tableWrap{flex:1;min-height:0;overflow:auto;border-top:1px solid #1f2430}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #1f2430;padding:10px 8px;text-align:left;vertical-align:top}
th{position:sticky;top:0;background:#0b0d12;font-size:16px;font-weight:800;color:#eaeef7}
td{font-size:16px;font-weight:400}
a{color:#93c5fd;text-decoration:none}a:hover{text-decoration:underline}
.ok{color:#86efac}.bad{color:#fca5a5}.unk{color:#fcd34d}

/* ✅ modal/toast */
.ovl{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:9999}
.modal{background:#111827;border:1px solid #2a3140;border-radius:12px;padding:14px 16px;max-width:560px;width:calc(100% - 40px);text-align:center}
.mtxt{font-size:14px;font-weight:700;line-height:1.35}
.mbtns{display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap}

@media (max-width:1100px){main{grid-template-columns:1fr}.list{grid-template-columns:1fr}}
@media (max-width:900px){aside{border-right:0;border-bottom:1px solid #1f2430}th{position:static}}
</style></head><body>

<div class="ovl" id="ovl"><div class="modal" id="modal"></div></div>

<main>
<aside>
  <div class="btnrow">
    <button id="btnAll">Tümünü Seç</button>
    <button id="btnNone">Temizle</button>
    <button id="btnScan">Tarama Başlat</button>
    <button id="btnStop" disabled>Durdur</button>
    <button id="btnExport" disabled>CSV Çıktı</button>
  </div>

  <div class="ibox" id="info"></div>
  <div class="list" id="brandList"></div>
</aside>

<section>
  <div class="tableWrap">
    <table><thead><tr>
      <th>Sıra No</th><th>Marka</th><th>Ürün Adı</th><th>Ürün Kodu</th><th>Stok</th><th>EAN</th>
    </tr></thead><tbody id="rows"></tbody></table>
  </div>
</section>
</main>

<script>
const API_BASE="https://robot-workstation.tvkapora.workers.dev",$=id=>document.getElementById(id),
E={l:$("brandList"),a:$("btnAll"),n:$("btnNone"),s:$("btnScan"),p:$("btnStop"),x:$("btnExport"),i:$("info"),r:$("rows"),ovl:$("ovl"),mdl:$("modal")};

let B=[],S=new Set,R=[],N=0,Exp=new Map,Found=new Map,abortCtrl=null,scanning=false;

const DISP=new Map([["Marantz Professional","Marantz Prof."],["Rupert Neve Designs","Rupert Neve D."]]),dn=n=>DISP.get(n)||n;
const esc=s=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");

function info(s){
  E.i.innerHTML="";
  const lines=String(s??"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  for(const t of lines){
    const sp=document.createElement("span");
    sp.className="chip";
    sp.textContent=t;
    E.i.appendChild(sp);
  }
}

function showToast(msg, ms=2200){
  E.mdl.innerHTML=`<div class="mtxt">${esc(msg)}</div>`;
  E.ovl.style.display="flex";
  const close=()=>{E.ovl.style.display="none";E.ovl.onclick=null;};
  E.ovl.onclick=close;
  window.setTimeout(close, ms);
}

function confirmModal(msg){
  return new Promise(resolve=>{
    E.mdl.innerHTML=
      `<div class="mtxt">${esc(msg)}</div>
       <div class="mbtns">
         <button id="mYes">Evet</button>
         <button id="mNo">Hayır</button>
       </div>`;
    E.ovl.style.display="flex";
    const done=v=>{E.ovl.style.display="none";E.ovl.onclick=null;resolve(v);};
    $("mYes").onclick=()=>done(true);
    $("mNo").onclick=()=>done(false);
    E.ovl.onclick=(e)=>{ if(e.target===E.ovl) done(false); };
  });
}

const setScanState=on=>{
  scanning=on;
  E.s.disabled=on; E.a.disabled=on; E.x.disabled=on||R.length===0;
  E.p.disabled=!on;
};

const rowCls=st=>{const t=(st||"").toLowerCase();return t.includes("yok")?"bad":t.includes("bilinmiyor")?"unk":"ok"};
const sum=chosen=>{const L=[];for(const b of chosen){const e=Exp.get(b.name),f=Found.get(b.name)||0;
  L.push(typeof e==="number"?`${b.name}: ${f}/${e} ${f===e?"✅":`⚠️ (fark ${f-e})`}`:`${b.name}: ${f}/?`)}return L.join("\n")};

function render(){
  E.l.innerHTML="";
  [...B].sort((a,b)=>a.name.localeCompare(b.name,"tr",{sensitivity:"base"})).forEach((b,i)=>{
    const d=document.createElement("div");
    d.className="brand"+(S.has(b.id)?" sel":""); d.tabIndex=0; d.dataset.id=b.id;
    d.innerHTML=`<div class="row"><span class="idx">${i+1})</span><span class="nm" title="${esc(dn(b.name))}">${esc(dn(b.name))}</span><span class="ct">(${esc(b.count)})</span></div>`;
    E.l.appendChild(d);
  });
}

const toggle=(id,el)=>{S.has(id)?(S.delete(id),el.classList.remove("sel")):(S.add(id),el.classList.add("sel"))};
E.l.addEventListener("click",e=>{const el=e.target.closest(".brand");if(!el)return;toggle(+el.dataset.id,el)});
E.l.addEventListener("keydown",e=>{if(e.key!=="Enter"&&e.key!==" ")return;const el=e.target.closest(".brand");if(!el)return;e.preventDefault();toggle(+el.dataset.id,el)});

function add(r){
  N++;
  const o={sıra:N,brand:r.brand||"",title:r.title||"Ürün",productCode:r.productCode||"",stock:r.stock||"",ean:r.ean||"",url:r.url||""};
  R.push(o);
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${esc(o.sıra)}</td><td>${esc(o.brand)}</td><td></td><td>${esc(o.productCode)}</td><td class="${rowCls(o.stock)}">${esc(o.stock)}</td><td>${esc(o.ean)}</td>`;
  const tdT=tr.children[2];
  if(o.url){const a=document.createElement("a");a.href=o.url;a.target="_blank";a.rel="noopener";a.textContent=o.title;tdT.appendChild(a)}
  else tdT.textContent=o.title;
  E.r.appendChild(tr);
  E.x.disabled=scanning||R.length===0;
}

function clearAll(){
  if(scanning && abortCtrl) abortCtrl.abort();
  S.clear(); R=[]; N=0; E.r.innerHTML=""; Exp=new Map; Found=new Map;
  render(); E.x.disabled=true; info("Temizlendi."); setScanState(false);
}

function csv(){
  const D=";",v=x=>{const s=String(x??"");return(s.includes('"')||s.includes("\n")||s.includes("\r")||s.includes(D))?`"${s.replaceAll('"','""')}"`:s;};
  const h=["Sıra No","Marka","Ürün Adı","Ürün Kodu","Stok","EAN"].map(v).join(D);
  const L=R.map(r=>[r.sıra,r.brand,r.title,r.productCode,r.stock,r.ean].map(v).join(D));
  const out="\ufeff"+[h,...L].join("\r\n"),blob=new Blob([out],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="compel-sonuc.csv";document.body.appendChild(a);a.click();URL.revokeObjectURL(a.href);a.remove();
}

async function load(){
  info("Markalar yükleniyor...");
  const res=await fetch(`${API_BASE}/api/brands`,{cache:"no-store"});
  if(!res.ok){const t=await res.text().catch(()=> "");throw new Error(`API /api/brands hata: ${res.status}\n${t}`)}
  B=await res.json(); render();
  info(`Hazır. Marka sayısı: ${B.length}`);
}

async function scan(doConfirm=true){
  if(scanning) return;
  if(!S.size){info("En az 1 marka seç.");return;}

  if(doConfirm && S.size===B.length){
    const ok=await confirmModal("Tüm markaları taramak üzeresiniz. Emin misiniz?");
    if(!ok) return;
  }

  R=[];N=0;E.r.innerHTML="";Found=new Map;
  setScanState(true); info("Başladı...");

  const chosen=B.filter(b=>S.has(b.id));
  Exp=new Map(chosen.map(b=>[b.name,Number(b.count)]).filter(x=>Number.isFinite(x[1])));

  abortCtrl=new AbortController();
  try{
    const res=await fetch(`${API_BASE}/api/scan`,{
      method:"POST",headers:{"content-type":"application/json"},
      body:JSON.stringify({brands:chosen}),
      signal:abortCtrl.signal
    });
    if(!res.ok){const t=await res.text().catch(()=> "");info(`Hata: ${res.status}\n${t}`);setScanState(false);return;}
    const rd=res.body?.getReader?.(); if(!rd){info("Tarama bitti (stream yok).");setScanState(false);return;}

    const dec=new TextDecoder(); let buf="",total=0;
    while(true){
      const {value,done}=await rd.read(); if(done)break;
      buf+=dec.decode(value,{stream:true});
      let i; while((i=buf.indexOf("\n"))>=0){
        const line=buf.slice(0,i).trim(); buf=buf.slice(i+1);
        if(!line) continue;
        const m=JSON.parse(line);

        if(m.type==="brandStart"||m.type==="page"){
          const e=Exp.get(m.brand),f=Found.get(m.brand)||0;
          info(`Taranıyor: ${m.brand} (sayfa ${m.page}/${m.pages})\nBulunan/Beklenen: ${f}/${(typeof e==="number"?e:"?")}`);
        } else if(m.type==="product"){
          total++; const bn=m.data?.brand||""; if(bn) Found.set(bn,(Found.get(bn)||0)+1);
          add(m.data);
        } else if(m.type==="brandDone"){
          const e=typeof m.expected==="number"?m.expected:Exp.get(m.brand);
          const f=typeof m.found==="number"?m.found:(Found.get(m.brand)||0);
          const ok=typeof e==="number"?f===e:null;
          info(`${m.brand} bitti.\nBulunan/Beklenen: ${f}/${(typeof e==="number"?e:"?")} ${ok===true?"✅":ok===false?"⚠️":""}\nGenel: ${total}`);
        } else if(m.type==="done"){
          const lines=sum(chosen).split("\n").filter(Boolean);
          info(`Bitti. Toplam ürün: ${total}\nKontrol:\n${lines.join("\n")}`);
        } else if(m.type==="error"){
          info(`Hata: ${m.message}`);
        }
      }
    }
  } catch(e){
    if(abortCtrl?.signal?.aborted) info("Durduruldu.");
    else info("Hata:\n"+(e?.message||e));
  } finally{
    abortCtrl=null;
    setScanState(false);
    E.x.disabled=R.length===0;
  }
}

E.a.onclick=()=>{
  B.forEach(b=>S.add(b.id)); render();
  showToast("Gün içerisinde kullanımı önerilmez.");
};
E.n.onclick=clearAll;
E.s.onclick=()=>scan(true);
E.p.onclick=()=>{if(scanning && abortCtrl) abortCtrl.abort();};
E.x.onclick=csv;

load().catch(e=>info("Markalar yüklenemedi:\n"+(e?.message||e)));
</script></body></html>
