export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // CORS / preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, { status: 204, headers: corsHeaders() });
    }

    try {
      if (url.pathname === '/api/brands') {
        return jsonResponse({ brands: BRANDS });
      }

      if (url.pathname === '/api/brand-products') {
        const brandId = String(url.searchParams.get('brandId') || '').trim();
        const page = Math.max(1, parseInt(url.searchParams.get('page') || '1', 10) || 1);
        const brand = BRANDS.find(b => String(b.id) === brandId);
        if (!brand) return jsonResponse({ error: 'brandId gecersiz' }, 400);

        const brandUrl = new URL(`https://compel.com.tr/brand/${brand.id}-${brand.slug}`);
        if (page > 1) brandUrl.searchParams.set('page', String(page));

        const html = await fetchText(brandUrl.toString());
        const products = parseBrandPageProducts(html);

        // inject brand name and dedupe by url
        const seen = new Set();
        const out = [];
        for (const p of products) {
          const key = p.url;
          if (!key || seen.has(key)) continue;
          seen.add(key);
          out.push({
            brandId: brand.id,
            brandName: brand.name,
            listingTitle: p.listingTitle,
            stock: p.stock,
            url: p.url,
          });
        }
        return jsonResponse({ brand, page, products: out });
      }

      if (url.pathname === '/api/product-details') {
        const raw = url.searchParams.get('url') || '';
        if (!raw) return jsonResponse({ error: 'url eksik' }, 400);

        let target;
        try {
          target = new URL(raw);
        } catch {
          return jsonResponse({ error: 'url gecersiz' }, 400);
        }

        // basic safety: only allow compel.com.tr
        const host = target.hostname.toLowerCase();
        if (!(host === 'compel.com.tr' || host.endsWith('.compel.com.tr'))) {
          return jsonResponse({ error: 'sadece compel.com.tr linkleri' }, 400);
        }

        const html = await fetchText(target.toString());
        const details = parseProductDetails(html);
        return jsonResponse({ url: target.toString(), ...details });
      }

      // default
      return new Response('OK', {
        status: 200,
        headers: { ...corsHeaders(), 'content-type': 'text/plain; charset=utf-8' },
      });
    } catch (err) {
      return jsonResponse({ error: String(err && err.message ? err.message : err) }, 500);
    }
  },
};

function corsHeaders() {
  return {
    'access-control-allow-origin': '*',
    'access-control-allow-methods': 'GET,OPTIONS',
    'access-control-allow-headers': 'content-type',
    'access-control-max-age': '86400',
  };
}

function jsonResponse(obj, status = 200) {
  return new Response(JSON.stringify(obj), {
    status,
    headers: {
      ...corsHeaders(),
      'content-type': 'application/json; charset=utf-8',
      'cache-control': 'no-store',
    },
  });
}

async function fetchText(u) {
  const res = await fetch(u, {
    headers: {
      'user-agent':
        'Mozilla/5.0 (compatible; RobotWorkstation/1.0; +https://robot-workstation.tvkapora.workers.dev)',
      accept: 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
      'accept-language': 'tr-TR,tr;q=0.9,en;q=0.8',
    },
  });
  if (!res.ok) throw new Error(`fetch fail ${res.status} ${res.statusText}`);
  return await res.text();
}

function parseBrandPageProducts(html) {
  // find product titles + links
  const re =
    /<h[23][^>]*class="[^"]*product-title[^"]*"[^>]*>\s*<a[^>]*href="([^"]+)"[^>]*>([\s\S]*?)<\/a>/gi;
  const matches = [];
  let m;
  while ((m = re.exec(html)) !== null) {
    const href = m[1];
    const titleHtml = m[2];
    const abs = new URL(href, 'https://compel.com.tr').toString();
    const title = cleanText(titleHtml);
    matches.push({ idx: m.index, url: abs, listingTitle: title });
  }

  // slice per product to get stock nearby
  const out = [];
  for (let i = 0; i < matches.length; i++) {
    const start = matches[i].idx;
    const end =
      i + 1 < matches.length ? matches[i + 1].idx : Math.min(html.length, start + 8000);
    const seg = html.slice(start, end);
    const text = cleanText(seg);

    let stock = '';
    const qty = text.match(/Stok\s*Durumu\s*:\s*([0-9]+)\s*Stokta\s*Var/i);
    if (qty) {
      stock = `${qty[1]} Stokta Var`;
    } else if (/Stokta\s*Yok/i.test(text) || /T\u00fckendi/i.test(text) || /stok.*yok/i.test(text)) {
      stock = 'Stokta Yok';
    } else if (/Stokta\s*Var/i.test(text)) {
      stock = 'Stokta Var';
    }

    out.push({ url: matches[i].url, listingTitle: matches[i].listingTitle, stock });
  }

  // dedupe by url
  const seen = new Set();
  return out.filter(p => {
    if (!p.url || seen.has(p.url)) return false;
    seen.add(p.url);
    return true;
  });
}

function parseProductDetails(html) {
  // product name
  let name = '';
  const h1 = html.match(/<h1[^>]*>([\s\S]*?)<\/h1>/i);
  if (h1) name = cleanText(h1[1]);
  if (!name) {
    const og = html.match(/<meta\s+property="og:title"\s+content="([^"]+)"/i);
    if (og) name = cleanText(og[1]);
  }
  if (!name) {
    const t = html.match(/<title[^>]*>([\s\S]*?)<\/title>/i);
    if (t) name = cleanText(t[1]).replace(/\s*\|\s*Compel.*$/i, '').trim();
  }

  const text = cleanText(html);

  // product code: "Ürün Kodu"
  const codeRe = new RegExp('\\u00dcr\\u00fcn\\s*Kodu\\s*([A-Za-z0-9._-]+)', 'i');
  const codeM = text.match(codeRe);
  const productCode = codeM ? codeM[1] : '';

  // EAN
  let ean = '';
  const e1 = text.match(/ean13\s*([0-9]{8,14})/i);
  if (e1) ean = e1[1];
  const e2 = !ean ? text.match(/EAN\s*[:\-]?\s*([0-9]{8,14})/i) : null;
  if (e2) ean = e2[1];

  // stock
  let stock = '';
  const qty = text.match(/Stok\s*Durumu\s*:\s*([0-9]+)\s*Stokta\s*Var/i);
  if (qty) {
    stock = `${qty[1]} Stokta Var`;
  } else if (/Stokta\s*Yok/i.test(text) || /T\u00fckendi/i.test(text) || /stok.*yok/i.test(text)) {
    stock = 'Stokta Yok';
  } else if (/Stokta\s*Var/i.test(text)) {
    stock = 'Stokta Var';
  }

  return { name, productCode, ean, stock };
}

function cleanText(input) {
  if (!input) return '';
  let s = String(input);
  // remove scripts/styles
  s = s.replace(/<script[\s\S]*?<\/script>/gi, ' ');
  s = s.replace(/<style[\s\S]*?<\/style>/gi, ' ');
  // tags -> spaces
  s = s.replace(/<[^>]+>/g, ' ');

  // decode minimal entities
  s = s
    .replace(/&nbsp;/gi, ' ')
    .replace(/&amp;/gi, '&')
    .replace(/&quot;/gi, '"')
    .replace(/&#039;/g, "'")
    .replace(/&lt;/gi, '<')
    .replace(/&gt;/gi, '>');

  // numeric entities
  s = s.replace(/&#(\d+);/g, (_, n) => {
    const code = parseInt(n, 10);
    if (!Number.isFinite(code)) return '';
    try {
      return String.fromCharCode(code);
    } catch {
      return '';
    }
  });
  s = s.replace(/&#x([0-9a-fA-F]+);/g, (_, h) => {
    const code = parseInt(h, 16);
    if (!Number.isFinite(code)) return '';
    try {
      return String.fromCharCode(code);
    } catch {
      return '';
    }
  });

  // normalize whitespace
  s = s.replace(/\s+/g, ' ').trim();
  return s;
}

const BRANDS = [
  { id: 1, name: 'Ableton', slug: 'ableton', productCount: 10 },
  { id: 48, name: 'Allen & Heath', slug: 'allen-heath', productCount: 8 },
  { id: 4, name: 'Arturia', slug: 'arturia', productCount: 61 },
  { id: 6, name: 'Avalon', slug: 'avalon', productCount: 4 },
  { id: 7, name: 'Avid', slug: 'avid', productCount: 16 },
  { id: 49, name: 'Compel', slug: 'compel', productCount: 3 },
  { id: 41, name: 'Cranborne Audio', slug: 'cranborne-audio', productCount: 9 },
  { id: 9, name: 'Crane Song', slug: 'crane-song', productCount: 6 },
  { id: 10, name: 'Denon DJ', slug: 'denon-dj', productCount: 10 },
  { id: 50, name: 'Fender Studio', slug: 'fender-studio', productCount: 8 },
  { id: 11, name: 'Genelec', slug: 'genelec', productCount: 25 },
  { id: 12, name: 'HeadRush', slug: 'headrush', productCount: 8 },
  { id: 13, name: 'Hosa', slug: 'hosa', productCount: 296 },
  { id: 16, name: 'M-Audio', slug: 'm-audio', productCount: 50 },
  { id: 44, name: 'M-Game', slug: 'm-game', productCount: 2 },
  { id: 17, name: 'Marantz Professional', slug: 'marantz-professional', productCount: 9 },
  { id: 20, name: 'Numark', slug: 'numark', productCount: 33 },
  { id: 21, name: 'PreSonus', slug: 'presonus', productCount: 97 },
  { id: 23, name: 'Rane', slug: 'rane', productCount: 10 },
  { id: 25, name: 'Rupert Neve Designs', slug: 'rupert-neve-designs', productCount: 8 },
  { id: 24, name: 'R\u00d8DE', slug: 'rode', productCount: 245 },
  { id: 45, name: 'R\u00d8DE X', slug: 'rode-x', productCount: 3 },
  { id: 47, name: 'Sheeran Loopers', slug: 'sheeran-loopers', productCount: 2 },
  { id: 26, name: 'Sibelius', slug: 'sibelius', productCount: 6 },
  { id: 28, name: 'Sonarworks', slug: 'sonarworks', productCount: 12 },
  { id: 43, name: 'SoundSwitch', slug: 'soundswitch', productCount: 1 },
  { id: 42, name: 'Stanton', slug: 'stanton', productCount: 3 },
  { id: 36, name: 'Universal Audio', slug: 'universal-audio', productCount: 73 },
  { id: 38, name: 'Warm Audio', slug: 'warm-audio', productCount: 79 },
];
