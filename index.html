<!doctype html><html lang=tr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Compel Marka Tarayıcı</title><style>
:root{color-scheme:dark}html,body{height:100%}body{margin:0;height:100vh;overflow:hidden;display:flex;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0d12;color:#eaeef7}
main{flex:1;overflow:hidden;display:grid;grid-template-columns:560px 1fr;min-height:0}
aside{border-right:1px solid #1f2430;padding:8px 12px;overflow:hidden;display:flex;flex-direction:column;min-height:0}
section{padding:8px 12px;overflow:hidden;display:flex;flex-direction:column;min-height:0}
.btnrow{display:flex;gap:8px;margin:0 0 10px;flex-wrap:wrap;flex:0 0 auto}
button,.statusBox{background:#111827;color:#eaeef7;border:1px solid #2a3140;border-radius:10px;font-weight:600;font-size:13px}
button{padding:8px 10px;cursor:pointer}button:hover{border-color:#3a465f}button:disabled{opacity:.6;cursor:not-allowed}

/* ✅ 2 sütun + minimum hücre genişliği */
.list{flex:1;min-height:0;overflow:auto;display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:6px;align-content:start}

/* ✅ kart biraz daha geniş/rahat, çok satır destek */
label.brand{display:flex;gap:8px;align-items:flex-start;padding:6px 8px;border:1px solid #1f2430;border-radius:12px;background:#0f1320}
label.brand:hover{border-color:#2a3140}label.brand input{width:17px;height:17px;flex:0 0 auto;margin-top:2px}
.meta{min-width:0;flex:1}
.nameRow{display:grid;grid-template-columns:30px 1fr 64px;gap:6px;align-items:start}
.nameRow .idx{font-variant-numeric:tabular-nums;opacity:.9}
.nameRow .nm{white-space:normal;word-break:break-word;overflow:visible}
.nameRow .ct{opacity:.9;text-align:right}
.meta .name{font-weight:800;font-size:12px;line-height:1.18}

.topbar{display:flex;gap:8px;flex-wrap:wrap;align-items:stretch;margin-bottom:8px;flex:0 0 auto}
.rightBtns{display:flex;gap:8px;flex-wrap:wrap}
.statusBox{padding:8px 10px;overflow:auto;flex:1 1 360px;max-height:92px}
.spre{font-size:13px;font-weight:600;line-height:1.25;white-space:normal}
.srow{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.chip{white-space:nowrap}

.tableWrap{flex:1;min-height:0;overflow:auto;border-top:1px solid #1f2430}
table{width:100%;border-collapse:collapse}th,td{border-bottom:1px solid #1f2430;padding:10px 8px;text-align:left;vertical-align:top}
th{font-size:12px;color:#cbd5e1;position:sticky;top:0;background:#0b0d12}td{font-size:13px;color:#eaeef7}
a{color:#93c5fd;text-decoration:none}a:hover{text-decoration:underline}
.ok{color:#86efac}.bad{color:#fca5a5}.unk{color:#fcd34d}
@media (max-width:1100px){main{grid-template-columns:1fr}.list{grid-template-columns:1fr}}
@media (max-width:900px){aside{border-right:0;border-bottom:1px solid #1f2430}th{position:static}}
</style></head><body><main>
<aside><div class=btnrow><button id=btnAll>Tümünü Seç</button><button id=btnNone>Temizle</button><button id=btnScan>Taramayı Başlat</button></div><div class=list id=brandList></div></aside>
<section><div class=topbar><div class=rightBtns><button id=btnExport disabled>CSV Export</button><button id=btnClear disabled>Sonuçları Temizle</button></div><div class=statusBox id=status>Hazır.</div></div>
<div class=tableWrap><table><thead><tr><th>Sıra No</th><th>Marka</th><th>Ürün Adı</th><th>Ürün Kodu</th><th>Stok</th><th>EAN</th></tr></thead><tbody id=rows></tbody></table></div></section>
</main><script>
const API_BASE="https://robot-workstation.tvkapora.workers.dev",$=id=>document.getElementById(id),
E={l:$("brandList"),a:$("btnAll"),n:$("btnNone"),s:$("btnScan"),x:$("btnExport"),c:$("btnClear"),t:$("status"),r:$("rows")};
let B=[],S=new Set,R=[],N=0,Exp=new Map,Found=new Map,Rep=new Map;
const esc=s=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
const setScan=o=>{E.s.disabled=o;E.a.disabled=o;E.n.disabled=o;};
const rowCls=st=>{const t=(st||"").toLowerCase();return t.includes("yok")?"bad":t.includes("bilinmiyor")?"unk":"ok"};
const setText=s=>E.t.innerHTML=`<div class=spre>${esc(s).replaceAll("\n","<br>")}</div>`;
const sum=chosen=>{const L=[];for(const b of chosen){const e=Exp.get(b.name),f=Found.get(b.name)||0;
L.push(typeof e==="number"?`${b.name}: ${f}/${e} ${f===e?"✅":`⚠️ (fark ${f-e})`}`:`${b.name}: ${f}/?`)}return L.join("\n")};
function setDone(total,chosen){
const lines=sum(chosen).split("\n").filter(Boolean);
E.t.innerHTML=`<div class=srow><span class=chip>Bitti. Toplam ürün: ${total}</span><span class=chip>Kontrol (Bulunan/Beklenen):</span>${lines.map(x=>`<span class=chip>${esc(x)}</span>`).join("")}</div>`}
function render(){
E.l.innerHTML="";
[...B].sort((a,b)=>a.name.localeCompare(b.name,"tr",{sensitivity:"base"})).forEach((b,i)=>{
const lb=document.createElement("label");lb.className="brand";
const cb=document.createElement("input");cb.type="checkbox";cb.checked=S.has(b.id);
cb.addEventListener("change",()=>cb.checked?S.add(b.id):S.delete(b.id));
const meta=document.createElement("div");meta.className="meta";
const nm=document.createElement("div");nm.className="name";
const row=document.createElement("div");row.className="nameRow";
const s1=document.createElement("span");s1.className="idx";s1.textContent=`${i+1})`;
const s2=document.createElement("span");s2.className="nm";s2.textContent=b.name;
const s3=document.createElement("span");s3.className="ct";s3.textContent=`(${b.count})`;
row.append(s1,s2,s3);nm.appendChild(row);meta.appendChild(nm);lb.append(cb,meta);E.l.appendChild(lb)})}
function add(r){
N++;const o={sıra:N,brand:r.brand||"",title:r.title||"Ürün",productCode:r.productCode||"",stock:r.stock||"",ean:r.ean||"",url:r.url||""};R.push(o);
const tr=document.createElement("tr"),tdNo=document.createElement("td");tdNo.textContent=String(o.sıra);
const tdB=document.createElement("td");tdB.textContent=o.brand;
const tdT=document.createElement("td");
if(o.url){const a=document.createElement("a");a.href=o.url;a.target="_blank";a.rel="noopener";a.textContent=o.title;tdT.appendChild(a)}else tdT.textContent=o.title;
const tdC=document.createElement("td");tdC.textContent=o.productCode;
const tdS=document.createElement("td");tdS.textContent=o.stock;tdS.className=rowCls(o.stock);
const tdE=document.createElement("td");tdE.textContent=o.ean;
tr.append(tdNo,tdB,tdT,tdC,tdS,tdE);E.r.appendChild(tr);
E.x.disabled=R.length===0;E.c.disabled=R.length===0}
function clear(){
R=[];N=0;E.r.innerHTML="";E.x.disabled=true;E.c.disabled=true;
Exp=new Map;Found=new Map;Rep=new Map;setText("Temizlendi.")}
function csv(){
const D=";",v=x=>{const s=String(x??"");return(s.includes('"')||s.includes("\n")||s.includes("\r")||s.includes(D))?`"${s.replaceAll('"','""')}"`:s;};
const h=["Sıra No","Marka","Ürün Adı","Ürün Kodu","Stok","EAN"].map(v).join(D);
const L=R.map(r=>[r.sıra,r.brand,r.title,r.productCode,r.stock,r.ean].map(v).join(D));
const out="\ufeff"+[h,...L].join("\r\n"),blob=new Blob([out],{type:"text/csv;charset=utf-8"});
const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="compel-sonuc.csv";document.body.appendChild(a);a.click();URL.revokeObjectURL(a.href);a.remove()}
async function load(){
setText("Markalar yükleniyor (compel.com.tr/markalar)...");const res=await fetch(`${API_BASE}/api/brands`,{cache:"no-store"});
if(!res.ok){const t=await res.text().catch(()=> "");throw new Error(`API /api/brands hata: ${res.status}\n${t}`)}
B=await res.json();render();setText(`Hazır. Marka sayısı: ${B.length}\nNot: Adetler compel.com.tr/markalar sayfasından çekilir.`)}
async function scan(){
if(!S.size){setText("En az 1 marka seç.");return}
clear();setScan(true);setText("Başladı...");
const chosen=B.filter(b=>S.has(b.id));Exp=new Map(chosen.map(b=>[b.name,Number(b.count)]).filter(x=>Number.isFinite(x[1])));
const res=await fetch(`${API_BASE}/api/scan`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({brands:chosen})});
if(!res.ok){const t=await res.text().catch(()=> "");setText(`Hata: ${res.status}\n${t}`);setScan(false);return}
const rd=res.body?.getReader?.();if(!rd){setText("Tarama bitti (stream yok).");setScan(false);return}
const dec=new TextDecoder();let buf="",total=0;
while(true){
const {value,done}=await rd.read();if(done)break;buf+=dec.decode(value,{stream:true});
let i;while((i=buf.indexOf("\n"))>=0){
const line=buf.slice(0,i).trim();buf=buf.slice(i+1);if(!line)continue;const m=JSON.parse(line);
if(m.type==="brandStart"||m.type==="page"){
const e=Exp.get(m.brand),f=Found.get(m.brand)||0;
setText(`Taranıyor: ${m.brand} (sayfa ${m.page}/${m.pages})\nBulunan/Beklenen: ${f}/${(typeof e==="number"?e:"?")}`)}
else if(m.type==="product"){total++;const bn=m.data?.brand||"";if(bn)Found.set(bn,(Found.get(bn)||0)+1);add(m.data)}
else if(m.type==="brandDone"){
Rep.set(m.brand,{expected:m.expected??null,found:m.found??0});
const e=typeof m.expected==="number"?m.expected:Exp.get(m.brand);
const f=typeof m.found==="number"?m.found:(Found.get(m.brand)||0);
const ok=typeof e==="number"?f===e:null;
E.t.innerHTML=`<div class=srow><span class=chip>${esc(m.brand)} bitti.</span><span class=chip>Bulunan/Beklenen: ${f}/${(typeof e==="number"?e:"?")} ${ok===true?"✅":ok===false?"⚠️":""}</span><span class=chip>Genel Toplam: ${total}</span></div><div class=spre style="margin-top:6px">${esc(sum(chosen)).replaceAll("\n","<br>")}</div>`}
else if(m.type==="done"){setDone(total,chosen)}
else if(m.type==="error"){setText(`Hata: ${m.message}`)}}}
setScan(false)}
E.a.addEventListener("click",()=>{B.forEach(b=>S.add(b.id));render()});
E.n.addEventListener("click",()=>{S.clear();render()});
E.s.addEventListener("click",scan);
E.x.addEventListener("click",csv);
E.c.addEventListener("click",clear);
load().catch(e=>setText("Markalar yüklenemedi:\n"+(e?.message||e)));
</script></body></html>
